<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¤‘ë³´ê¸°ë„íšŒ ê´‘ê³ </title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #FFFFFF;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      transition: all 1s ease;
      padding-top: 60px;
    }
    #slide {
      width: 90%;
      max-width: 1600px;
      margin-bottom: 20px;
      white-space: pre-line;
      padding: 20px;
      font-size: clamp(1.5rem, 5vw, 4rem);
      transition: all 1s ease;
      line-height: 1.5;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .control-panel {
      position: fixed;
      bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    .btn {
      padding: 12px 24px;
      font-size: clamp(0.8rem, 2vw, 1.2rem);
      cursor: pointer;
      background-color: rgba(255, 255, 255, 0.25);
      color: inherit;
      border: none;
      border-radius: 10px;
      transition: all 0.3s ease;
      font-weight: 500;
      backdrop-filter: blur(5px);
    }
    .btn:hover {
      background-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
    }
    #fullscreenButton {
      background-color: rgba(255, 255, 255, 0.25);
    }
    #fullscreenButton:hover {
      background-color: rgba(255, 255, 255, 0.4);
    }
    #colorPicker {
      width: 50px;
      height: 40px;
      padding: 0;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .hide-controls .control-panel {
      opacity: 0;
      transition: opacity 0.3s;
    }
    .hide-controls .control-panel:hover {
      opacity: 1;
    }
    .qr-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1001;
    }
    .qr-modal img {
      max-width: 300px;
      height: auto;
    }
    .qr-modal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 24px;
    }
    @media (orientation: portrait) {
      #slide {
        width: 95%;
        font-size: clamp(1.2rem, 7vw, 3rem);
      }
    }
    @media (min-width: 2560px) {
      #slide {
        max-width: 2000px;
        font-size: clamp(2rem, 4vw, 5rem);
      }
    }
    /* ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
    .nav-container {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 10px 0;
    }

    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .ad-section {
      position: fixed;
      top: 60px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 10px;
      max-width: 300px;
      z-index: 999;
    }

    .music-player {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .music-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .music-info {
      font-size: 0.9rem;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <nav class="nav-container">
    <div class="nav-content">
      <div class="nav-title">ì¤‘ë³´ê¸°ë„íšŒ</div>
      <div class="music-player">
        <div class="music-controls">
          <button id="musicButton" class="btn" onclick="toggleMusic()">ğŸ”ˆ ì¬ìƒ</button>
          <span id="musicTime" class="music-info">00:00 / 00:00</span>
        </div>
      </div>
    </div>
  </nav>

  <div class="ad-section" id="adSection">
    <h3>ê³µì§€ì‚¬í•­</h3>
    <div id="adContent"></div>
  </div>

  <div id="slide"></div>
  <div class="control-panel">
    <button id="fullscreenButton" class="btn">ì „ì²´í™”ë©´</button>
    <button id="themeButton" class="btn">í…Œë§ˆ ë³€ê²½</button>
    <button id="googleSlideButton" class="btn">êµ¬ê¸€ ìŠ¬ë¼ì´ë“œ</button>
    <button id="qrButton" class="btn">QR ì½”ë“œ</button>
  </div>

  <div id="qrModal" class="qr-modal">
    <span class="close-btn">&times;</span>
    <div id="qrCode"></div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // ì„¤ì •ê°’
    const GOOGLE_SLIDE_URL = "https://docs.google.com/presentation/u/0/";
    const QR_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfvbtqWGPS2iVopJH9t75bPREoa8suUrbiLivdOjCxTPiRO3g/viewform";
    const BACKGROUND_MUSIC_URL = "/Celestial Whisper.mp3";

    // í‘œì‹œí•  ë¬¸êµ¬(ê¸°ë„ì œëª©, ë§ì”€, ê´‘ê³ ë¬¸êµ¬)ë“¤ì„ ìŠ¬ë¼ì´ë“œ í˜•ì‹ìœ¼ë¡œ ë‹´ì€ ë°°ì—´
    const slides = [
      "ì•ˆì‹ì¼ ë§ì”€ ë¬µìƒê¸°ë„ & \n\nì¤‘ë³´ê¸°ë„ ì œëª©ì„ ë‚˜ëˆ•ë‹ˆë‹¤.",
      "ììœ ë¡­ê²Œ ê¸°ë„ì— ì°¸ê°€í•˜ì„¸ìš”!",
      "(ì¤‘ë³´ê¸°ë„ 1)\n\n4ì›” 19ì¼ ê°€ì¡± ì¹œì§€ ì„ êµì˜ ë‚  ë¶€í¥ì„ ìœ„í•œ ê¸°ë„",
      "(ì¤‘ë³´ê¸°ë„ 2)\n\n12ê¸° ì¹¨ë¡€ìë“¤ì„ ìœ„í•œ ì¤‘ë³´ê¸°ë„ ë“œë¦½ë‹ˆë‹¤",
      "(ì¤‘ë³´ê¸°ë„ 3)\n\nêµìš°ë“¤ì˜ ê°€ì •ë§ˆë‹¤ ì„±ë ¹ì˜ ì¸ë„í•˜ì‹¬ì„ ê¸°ë„ ë“œë¦½ë‹ˆë‹¤",
      "ì„±ê²½ ë§ì”€: ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ 5ì¥ 17ì ˆ\n\n'ì‰¬ì§€ ë§ê³  ê¸°ë„í•˜ë¼'",
      "ì„±ê²½ ë§ì”€: ë¹Œë¦½ë³´ì„œ 4ì¥ 6ì ˆ\n\n'ì•„ë¬´ ê²ƒë„ ì—¼ë ¤í•˜ì§€ ë§ê³  ë‹¤ë§Œ ëª¨ë“  ì¼ì— ê¸°ë„ì™€ ê°„êµ¬ë¡œ...'",
      "ì„±ê²½ ë§ì”€: ë§ˆíƒœë³µìŒ 7ì¥ 7ì ˆ\n\n'êµ¬í•˜ë¼ ê·¸ë¦¬í•˜ë©´ ë„ˆí¬ì—ê²Œ ì£¼ì‹¤ ê²ƒì´ìš”\n\nì°¾ìœ¼ë¼ ê·¸ë¦¬í•˜ë©´ ì°¾ì„ ê²ƒì´ìš”...'",
      "í•¨ê»˜ í•˜ëŠ” ê¸°ë„ ì‹œê°„\n\nì£¼ë‹˜ê³¼ì˜ ê¹Šì€ êµì œì— ì´ˆëŒ€í•©ë‹ˆë‹¤."
    ];

    // ìƒ‰ìƒ í…Œë§ˆ ì •ì˜
    const colorThemes = [
      { bg: '#1a1a1a', text: '#ffffff', name: 'ë‹¤í¬' },
      { bg: '#f0f0f0', text: '#2c3e50', name: 'ë¼ì´íŠ¸' },
      { bg: '#2c3e50', text: '#ecf0f1', name: 'ë¯¸ë“œë‚˜ì‡' },
      { bg: '#f1c40f', text: '#2c3e50', name: 'ì„ ìƒ¤ì¸' },
      { bg: '#27ae60', text: '#ffffff', name: 'í¬ë ˆìŠ¤íŠ¸' },
      { bg: '#8e44ad', text: '#ffffff', name: 'ë¯¸ìŠ¤í‹±' },
      { bg: '#2980b9', text: '#ffffff', name: 'ì˜¤ì…˜' },
      { bg: '#c0392b', text: '#ffffff', name: 'ë£¨ë¹„' },
      { bg: '#2c3e50', text: '#f1c40f', name: 'ê³¨ë“œ' },
      { bg: '#16a085', text: '#ffffff', name: 'ì—ë©”ë„ë“œ' }
    ];

    let currentThemeIndex = 0;
    let currentIndex = 0;
    let isPlaying = true;
    let intervalId = null;
    let audio = null;
    let isMusicPlaying = false;
    let musicButton = null;

    const displayElement = document.getElementById("slide");
    const fullscreenButton = document.getElementById("fullscreenButton");
    const themeButton = document.getElementById("themeButton");
    const googleSlideButton = document.getElementById("googleSlideButton");
    const qrButton = document.getElementById("qrButton");
    const qrModal = document.getElementById("qrModal");
    
    // QR ì½”ë“œ ì´ˆê¸°í™”
    const qrCode = new QRCode(document.getElementById("qrCode"), {
      text: QR_FORM_URL,
      width: 256,
      height: 256,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    // ê´‘ê³  ë‚´ìš© ë°°ì—´
    const advertisements = [
      "4ì›” 19ì¼ ê°€ì¡± ì¹œì§€ ì„ êµì˜ ë‚ ",
      "5ì›” 23-25 ì•ˆë©´ë„ ì¬ë¦¼ ì—°ìˆ˜ì› 12ê¸° ì¹¨ë¡€ì‹ ",
      "8ì›” ì¥ë§‰ì§‘íšŒ",
      "ì„ êµë¶€ ë¯¸íŒ… ë§¤ì£¼ ì•ˆì‹ì¼ ì˜¤í›„ 3ì‹œë¶€í„°"
    ];

    let currentAdIndex = 0;
    const adContent = document.getElementById("adContent");

    // ê´‘ê³  ìˆœí™˜ í•¨ìˆ˜
    function rotateAd() {
      adContent.textContent = advertisements[currentAdIndex];
      currentAdIndex = (currentAdIndex + 1) % advertisements.length;
    }

    // ìŒì•… ì´ˆê¸°í™” í•¨ìˆ˜ ê°œì„ 
    async function initAudio() {
      try {
        console.log('Initializing audio...');
        if (!audio) {
          audio = new Audio();
          audio.preload = 'auto';
          audio.loop = true;
          
          // ì˜¤ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì • ì „ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          audio.addEventListener('canplaythrough', () => {
            console.log('Audio can play through');
          });
          
          // ì˜¤ë””ì˜¤ ì†ŒìŠ¤ ì„¤ì •
          audio.src = BACKGROUND_MUSIC_URL;
          
          // ì˜¤ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ëŒ€ê¸°
          await new Promise((resolve, reject) => {
            audio.addEventListener('loadedmetadata', () => {
              console.log('Audio metadata loaded');
              resolve();
            });
            
            audio.addEventListener('error', (e) => {
              console.error('Audio load error:', e);
              console.error('Error code:', audio.error ? audio.error.code : 'unknown');
              reject(e);
            });
            
            // 5ì´ˆ í›„ì—ë„ ë¡œë“œë˜ì§€ ì•Šìœ¼ë©´ íƒ€ì„ì•„ì›ƒ
            setTimeout(() => {
              reject(new Error('Audio load timeout'));
            }, 5000);
          });
          
          audio.addEventListener('timeupdate', updateMusicTime);
          audio.addEventListener('ended', () => {
            console.log('Audio ended');
            audio.currentTime = 0;
            if (isMusicPlaying) {
              audio.play().catch(handlePlayError);
            }
          });
          
          audio.addEventListener('play', () => {
            console.log('Audio started playing');
          });
          
          audio.addEventListener('pause', () => {
            console.log('Audio paused');
          });
        }
        return true;
      } catch (error) {
        console.error('Audio initialization failed:', error);
        handlePlayError(error);
        return false;
      }
    }

    // ì¬ìƒ ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜ ê°œì„ 
    function handlePlayError(error) {
      console.error('Playback error:', error);
      console.error('Audio state:', {
        readyState: audio ? audio.readyState : 'no audio',
        paused: audio ? audio.paused : 'no audio',
        currentSrc: audio ? audio.currentSrc : 'no audio',
        error: audio && audio.error ? audio.error.code : 'no error'
      });
      
      isMusicPlaying = false;
      if (!musicButton) {
        musicButton = document.getElementById("musicButton");
      }
      musicButton.textContent = "ğŸ”‡ ì˜¤ë¥˜";
      document.getElementById("musicTime").textContent = "ìŒì•… ë¡œë“œ ì‹¤íŒ¨";
    }

    // ìŒì•… ì¬ìƒ/ì •ì§€ í† ê¸€ ê°œì„ 
    async function toggleMusic() {
      if (!musicButton) {
        musicButton = document.getElementById("musicButton");
      }

      try {
        console.log('Toggle music called. Current state:', isMusicPlaying);
        
        if (!audio) {
          console.log('Initializing audio for the first time');
          const initialized = await initAudio();
          if (!initialized) {
            throw new Error('Audio initialization failed');
          }
        }

        if (isMusicPlaying) {
          console.log('Attempting to pause audio');
          audio.pause();
          musicButton.textContent = "ğŸ”ˆ ì¬ìƒ";
          isMusicPlaying = false;
        } else {
          console.log('Attempting to play audio');
          try {
            // ì˜¤ë””ì˜¤ ë¡œë“œ ìƒíƒœ í™•ì¸
            if (audio.readyState < 2) { // HAVE_CURRENT_DATA
              console.log('Audio not ready, waiting for data...');
              await new Promise((resolve, reject) => {
                audio.addEventListener('canplay', resolve, { once: true });
                audio.addEventListener('error', reject, { once: true });
                // 3ì´ˆ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => reject(new Error('Audio load timeout')), 3000);
              });
            }
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
              await playPromise;
              console.log('Audio playing successfully');
              musicButton.textContent = "â¸ï¸ ì •ì§€";
              isMusicPlaying = true;
            }
          } catch (playError) {
            console.error('Play attempt failed:', playError);
            throw playError;
          }
        }
      } catch (error) {
        handlePlayError(error);
      }
    }

    // ìŒì•… ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ê°œì„ 
    function updateMusicTime() {
      if (!audio || audio.paused) return;
      
      try {
        const current = Math.floor(audio.currentTime);
        const duration = Math.floor(audio.duration);
        const currentMin = Math.floor(current / 60);
        const currentSec = current % 60;
        const durationMin = Math.floor(duration / 60);
        const durationSec = duration % 60;
        
        const timeElement = document.getElementById("musicTime");
        if (timeElement) {
          timeElement.textContent = 
            `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${durationMin}:${durationSec.toString().padStart(2, '0')}`;
        }
      } catch (error) {
        console.error('Error updating music time:', error);
      }
    }

    // QR ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
    function toggleQRModal() {
      const isVisible = qrModal.style.display === "block";
      qrModal.style.display = isVisible ? "none" : "block";
    }

    // êµ¬ê¸€ ìŠ¬ë¼ì´ë“œ ì—´ê¸°
    function openGoogleSlide() {
      window.open(GOOGLE_SLIDE_URL, '_blank');
    }
    
    // í…Œë§ˆ ë³€ê²½ í•¨ìˆ˜
    function changeTheme(index) {
      const theme = colorThemes[index];
      document.body.style.backgroundColor = theme.bg;
      document.body.style.color = theme.text;
      themeButton.textContent = `í…Œë§ˆ: ${theme.name}`;
    }

    // ë‹¤ìŒ í…Œë§ˆë¡œ ë³€ê²½
    function nextTheme() {
      currentThemeIndex = (currentThemeIndex + 1) % colorThemes.length;
      changeTheme(currentThemeIndex);
    }

    // ìë™ í…Œë§ˆ ë³€ê²½
    function startThemeChange() {
      return setInterval(() => {
        nextTheme();
      }, 30000); // 30ì´ˆë§ˆë‹¤ í…Œë§ˆ ë³€ê²½
    }

    // ìŠ¬ë¼ì´ë“œ í‘œì‹œ í•¨ìˆ˜
    function showSlide(index) {
      displayElement.textContent = slides[index];
      optimizeFontSize();
    }
    
    // ë‹¤ìŒ ìŠ¬ë¼ì´ë“œë¡œ ì „í™˜
    function nextSlide() {
      currentIndex = (currentIndex + 1) % slides.length;
      showSlide(currentIndex);
    }
    
    // ì „ì²´í™”ë©´ í† ê¸€ í•¨ìˆ˜
    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
          document.body.classList.add('hide-controls');
          fullscreenButton.textContent = "ì „ì²´í™”ë©´ ì¢…ë£Œ";
        });
      } else {
        document.exitFullscreen().then(() => {
          document.body.classList.remove('hide-controls');
          fullscreenButton.textContent = "ì „ì²´í™”ë©´";
        });
      }
      setTimeout(optimizeFontSize, 100);
    }
    
    // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ê¸€ì í¬ê¸° ìµœì í™”
    function optimizeFontSize() {
      const slide = document.getElementById('slide');
      const contentLength = slide.textContent.length;
      
      if (contentLength > 100) {
        slide.style.fontSize = 'clamp(1rem, 4vw, 3rem)';
      } else if (contentLength > 50) {
        slide.style.fontSize = 'clamp(1.2rem, 4.5vw, 3.5rem)';
      } else {
        slide.style.fontSize = 'clamp(1.5rem, 5vw, 4rem)';
      }
    }

    // ì´ˆê¸° ì„¤ì •
    showSlide(currentIndex);
    changeTheme(currentThemeIndex);
    intervalId = setInterval(nextSlide, 10000);
    const themeIntervalId = startThemeChange();
    
    // ê´‘ê³  ìˆœí™˜ ì¶”ê°€
    rotateAd();
    setInterval(rotateAd, 5000); // 5ì´ˆë§ˆë‹¤ ê´‘ê³  ë³€ê²½

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    fullscreenButton.addEventListener("click", toggleFullScreen);
    themeButton.addEventListener("click", nextTheme);
    googleSlideButton.addEventListener("click", openGoogleSlide);
    qrButton.addEventListener("click", toggleQRModal);
    document.querySelector(".close-btn").addEventListener("click", toggleQRModal);
    window.addEventListener('resize', optimizeFontSize);

    // ì „ì²´í™”ë©´ ë³€ê²½ ì´ë²¤íŠ¸
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('hide-controls');
        fullscreenButton.textContent = "ì „ì²´í™”ë©´";
      } else {
        document.body.classList.add('hide-controls');
        fullscreenButton.textContent = "ì „ì²´í™”ë©´ ì¢…ë£Œ";
      }
      setTimeout(optimizeFontSize, 100);
    });

    // ë¶€ëª¨ ì°½ì—ì„œ ì˜¤ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹  ê°œì„ 
    window.addEventListener('message', async function(event) {
      if (event.data.type === 'TOGGLE_MUSIC') {
        if (!audio) {
          await initAudio();
        }
        if (event.data.playing) {
          audio.play().catch(handlePlayError);
        } else {
          audio.pause();
        }
        isMusicPlaying = event.data.playing;
      } else if (event.data.type === 'GET_MUSIC_STATE') {
        window.parent.postMessage({
          type: 'MUSIC_STATE',
          playing: isMusicPlaying
        }, '*');
      }
    });
  </script>
</body>
</html>
